
#include <stdio.h>
#include "freertos/FreeRTOS.h"
#include "freertos/task.h"
#include "driver/spi_master.h"
#include "driver/gpio.h"
#include "esp_lcd_panel_io.h"
#include "esp_lcd_panel_vendor.h"
#include "esp_lcd_panel_ops.h"
#include "esp_log.h"
#include "LCD.h"

esp_lcd_panel_handle_t g_panel_handle = NULL;

// 全局LCD缓冲区
uint16_t *g_lcd_buffer = NULL;

// 分配LCD缓冲区
size_t buffer_size = LCD_H_RES * LCD_V_RES;


// 假设 font8x8_basic['A'] 是字符'A'的8x8点阵
void lcd_draw_char(int x, int y, char c, uint16_t color) {
    int idx = -1;
    if (c >= '0' && c <= '9') {
        idx = c - '0';
    } else if (c >= 'A' && c <= 'Z') {
        idx = c - 'A' + 10;
    } else {
        return; // 不支持的字符
    }
    for (int row = 0; row < 16; row++) {
        uint16_t bits = font16x16_ascii[idx][row];
        for (int col = 0; col < 16; col++) {
            if (bits & (1 << (15 - col))) {
                int px = x + col;
                int py = y + row;
                g_lcd_buffer[py * LCD_H_RES + px] = color;
            }
        }
    }
    // esp_lcd_panel_draw_bitmap(g_panel_handle, 0, 0, LCD_H_RES, LCD_V_RES, g_lcd_buffer);
}

void lcd_draw_string(int x, int y, const char *str, uint16_t color) {
    lcd_clear_buffer(0x0000); // 清屏，黑色背景
    int cursor_x = x;
    while (*str) {
        lcd_draw_char(cursor_x, y, *str, color);
        cursor_x += 16; // 每个字符宽度为16像素
        str++;
    }
    esp_lcd_panel_draw_bitmap(g_panel_handle, 0, 0, LCD_H_RES, LCD_V_RES, g_lcd_buffer);
}

void lcd_draw_string2(int x, int y, const char *str, uint16_t color) {
    // lcd_clear_buffer(0x0000); // 清屏，黑色背景
    int cursor_x = x;
    while (*str) {
        lcd_draw_char(cursor_x, y, *str, color);
        cursor_x += 16; // 每个字符宽度为16像素
        str++;
    }
    esp_lcd_panel_draw_bitmap(g_panel_handle, 0, 0, LCD_H_RES, LCD_V_RES, g_lcd_buffer);
}

//     // 打印int32范围的整数，包括正负号
void lcd_draw_int32(int x, int y, long int value, uint16_t color) {
    lcd_clear_buffer(0x0000); // 清屏，黑色背景
    char str[12]; // 最长-2147483648\0
    snprintf(str, sizeof(str), "%ld", value);
    lcd_draw_string2(x, y, str, color);
}


// 显示一张图片到指定位置
// image: 图像数据（RGB565），width/height: 图像宽高
void lcd_draw_image(int x, int y, int width, int height, const uint16_t *image) {
    // lcd_clear_buffer(0x0000); // 清屏，黑色背景
    for (int row = 0; row < height; row++) {
        for (int col = 0; col < width; col++) {
            int px = x + col;
            int py = y + row;
            if (px >= 0 && px < LCD_H_RES && py >= 0 && py < LCD_V_RES) {
                g_lcd_buffer[py * LCD_H_RES + px] = image[row * width + col];
            }
        }
    }
    esp_lcd_panel_draw_bitmap(g_panel_handle, 0, 0, LCD_H_RES, LCD_V_RES, g_lcd_buffer);
}


// 清除缓冲区，将所有像素设置为指定颜色
void lcd_clear_buffer(uint16_t color) {
    for (int i = 0; i < LCD_H_RES * LCD_V_RES; i++) {
        g_lcd_buffer[i] = color;
    }
    esp_lcd_panel_draw_bitmap(g_panel_handle, 0, 0, LCD_H_RES, LCD_V_RES, g_lcd_buffer);
}


// LCD初始化模块
void lcd_init(void) {

    ESP_LOGI("ST7789", "Initialize SPI bus");
    spi_bus_config_t buscfg = {
        .sclk_io_num = PIN_NUM_SCLK,
        .mosi_io_num = PIN_NUM_MOSI,
        .miso_io_num = PIN_NUM_MISO,
        .quadwp_io_num = -1,
        .quadhd_io_num = -1,
        .max_transfer_sz = LCD_H_RES * LCD_V_RES * sizeof(uint16_t),
    };
    ESP_ERROR_CHECK(spi_bus_initialize(LCD_HOST, &buscfg, SPI_DMA_CH_AUTO));

    ESP_LOGI("ST7789", "Install panel IO");
    esp_lcd_panel_io_handle_t io_handle = NULL;
    esp_lcd_panel_io_spi_config_t io_config = {
        .dc_gpio_num = PIN_NUM_DC,
        .cs_gpio_num = PIN_NUM_CS,
        .pclk_hz = LCD_PIXEL_CLOCK_HZ,
        .lcd_cmd_bits = 8,
        .lcd_param_bits = 8,
        .spi_mode = 0,
        .trans_queue_depth = 10,
    };
    ESP_ERROR_CHECK(esp_lcd_new_panel_io_spi((esp_lcd_spi_bus_handle_t)LCD_HOST, &io_config, &io_handle));

    ESP_LOGI("ST7789", "Install ST7789 panel driver");
    esp_lcd_panel_handle_t panel_handle = NULL;
    esp_lcd_panel_dev_config_t panel_config = {
        .reset_gpio_num = PIN_NUM_RST,
        .color_space = ESP_LCD_COLOR_SPACE_BGR,
        .bits_per_pixel = 16,
    };
    ESP_ERROR_CHECK(esp_lcd_new_panel_st7789(io_handle, &panel_config, &panel_handle));

    ESP_ERROR_CHECK(esp_lcd_panel_reset(panel_handle));
    ESP_ERROR_CHECK(esp_lcd_panel_init(panel_handle));
    ESP_ERROR_CHECK(esp_lcd_panel_disp_on_off(panel_handle, true));

    gpio_config_t bk_gpio_config = {
        .mode = GPIO_MODE_OUTPUT,
        .pin_bit_mask = 1ULL << PIN_NUM_BCKL,
    };
    ESP_ERROR_CHECK(gpio_config(&bk_gpio_config));
    ESP_ERROR_CHECK(gpio_set_level(PIN_NUM_BCKL, 0));

    g_panel_handle = panel_handle;
    g_lcd_buffer = heap_caps_malloc(buffer_size * sizeof(uint16_t), MALLOC_CAP_DMA | MALLOC_CAP_8BIT);
    // 不再返回panel_handle，专注于初始化
    for (int i = 0; i < buffer_size; i++){
        g_lcd_buffer[i] = 0x0000;
    } 
    esp_lcd_panel_draw_bitmap(g_panel_handle, 0, 0, LCD_H_RES, LCD_V_RES, g_lcd_buffer);
}



// 16x16大字体，包含0-9和A-Z
const uint16_t font16x16_ascii[36][16] = {
    // '0'
    {
        0x0000,0x07E0,0x0FF0,0x1C38,0x381C,0x300C,0x300C,0x300C,
        0x300C,0x300C,0x381C,0x1C38,0x0FF0,0x07E0,0x0000,0x0000
    },
    // '1'
    {
        0x0000,0x0180,0x0380,0x0780,0x0F80,0x1B80,0x3180,0x3180,
        0x3180,0x3180,0x3180,0x3180,0x3FFC,0x3FFC,0x0000,0x0000
    },
    // '2'
    {
        0x0000,0x07E0,0x0FF0,0x1C38,0x381C,0x001C,0x0038,0x0070,
        0x00E0,0x01C0,0x0380,0x0700,0x0FFC,0x1FFC,0x0000,0x0000
    },
    // '3'
    {
        0x0000,0x07E0,0x0FF0,0x1C38,0x001C,0x0038,0x01F0,0x01F0,
        0x001C,0x001C,0x381C,0x1C38,0x0FF0,0x07E0,0x0000,0x0000
    },
    // '4'
    {
        0x0000,0x0030,0x0070,0x00F0,0x01F0,0x03B0,0x0730,0x0E30,
        0x1C30,0x3FFC,0x3FFC,0x0030,0x0030,0x0030,0x0000,0x0000
    },
    // '5'
    {
        0x0000,0x1FFC,0x1FFC,0x1800,0x1800,0x1FE0,0x1FF0,0x1C38,
        0x001C,0x001C,0x381C,0x1C38,0x0FF0,0x07E0,0x0000,0x0000
    },
    // '6'
    {
        0x0000,0x07E0,0x0FF0,0x1C38,0x381C,0x3800,0x3FE0,0x3FF0,
        0x381C,0x381C,0x1C38,0x0FF0,0x07E0,0x0000,0x0000,0x0000
    },
    // '7'
    {
        0x0000,0x1FFC,0x1FFC,0x001C,0x0038,0x0070,0x00E0,0x01C0,
        0x0380,0x0700,0x0E00,0x0E00,0x0E00,0x0E00,0x0000,0x0000
    },
    // '8'
    {
        0x0000,0x07E0,0x0FF0,0x1C38,0x381C,0x1C38,0x0FF0,0x07E0,
        0x1C38,0x381C,0x1C38,0x0FF0,0x07E0,0x0000,0x0000,0x0000
    },
    // '9'
    {
        0x0000,0x07E0,0x0FF0,0x1C38,0x381C,0x381C,0x1FFC,0x0FFC,
        0x001C,0x381C,0x1C38,0x0FF0,0x07E0,0x0000,0x0000,0x0000
    },


    // A
    {
        0x0000,0x03C0,0x07E0,0x0C30,0x1818,0x1818,0x1818,0x3FFC,
        0x3FFC,0x300C,0x300C,0x300C,0x300C,0x0000,0x0000,0x0000
    },
    // B
    {
        0x0000,0x3FF8,0x3FFC,0x300C,0x300C,0x3FF8,0x3FFC,0x300C,
        0x300C,0x300C,0x3FFC,0x3FF8,0x0000,0x0000,0x0000,0x0000
    },
    // C
    {
        0x0000,0x07F8,0x0FFC,0x1C0C,0x3000,0x3000,0x3000,0x3000,
        0x3000,0x3000,0x1C0C,0x0FFC,0x07F8,0x0000,0x0000,0x0000
    },
    // D
    {
        0x0000,0x3FF0,0x3FF8,0x301C,0x300C,0x300C,0x300C,0x300C,
        0x300C,0x301C,0x3FF8,0x3FF0,0x0000,0x0000,0x0000,0x0000
    },
    // E
    {
        0x0000,0x3FFC,0x3FFC,0x3000,0x3000,0x3FF8,0x3FF8,0x3000,
        0x3000,0x3000,0x3FFC,0x3FFC,0x0000,0x0000,0x0000,0x0000
    },
    // F
    {
        0x0000,0x3FFC,0x3FFC,0x3000,0x3000,0x3FF8,0x3FF8,0x3000,
        0x3000,0x3000,0x3000,0x3000,0x0000,0x0000,0x0000,0x0000
    },
    // G
    {
        0x0000,0x07F8,0x0FFC,0x1C0C,0x3000,0x3000,0x31FC,0x31FC,
        0x300C,0x300C,0x1C0C,0x0FFC,0x07F8,0x0000,0x0000,0x0000
    },
    // H
    {
        0x0000,0x300C,0x300C,0x300C,0x300C,0x3FFC,0x3FFC,0x300C,
        0x300C,0x300C,0x300C,0x300C,0x0000,0x0000,0x0000,0x0000
    },
    // I
    {
        0x0000,0x1FF8,0x1FF8,0x0180,0x0180,0x0180,0x0180,0x0180,
        0x0180,0x0180,0x1FF8,0x1FF8,0x0000,0x0000,0x0000,0x0000
    },
    // J
    {
        0x0000,0x01FC,0x01FC,0x000C,0x000C,0x000C,0x000C,0x000C,
        0x300C,0x300C,0x1C1C,0x0FF8,0x07F0,0x0000,0x0000,0x0000
    },
    // K
    {
        0x0000,0x300C,0x301C,0x3038,0x3070,0x3FE0,0x3FC0,0x3FE0,
        0x3070,0x3038,0x301C,0x300C,0x0000,0x0000,0x0000,0x0000
    },
    // L
    {
        0x0000,0x3000,0x3000,0x3000,0x3000,0x3000,0x3000,0x3000,
        0x3000,0x3000,0x3FFC,0x3FFC,0x0000,0x0000,0x0000,0x0000
    },
    // M
    {
        0x0000,0x300C,0x381C,0x3C3C,0x3E7C,0x3FFC,0x3FFC,0x3FFC,
        0x3FFC,0x3FFC,0x300C,0x300C,0x0000,0x0000,0x0000,0x0000
    },
    // N
    {
        0x0000,0x300C,0x380C,0x3C0C,0x3E0C,0x3F0C,0x3F8C,0x3FCC,
        0x3FEC,0x3FFC,0x3FFC,0x300C,0x0000,0x0000,0x0000,0x0000
    },
    // O
    {
        0x0000,0x07F8,0x0FFC,0x1C0C,0x300C,0x300C,0x300C,0x300C,
        0x300C,0x300C,0x1C0C,0x0FFC,0x07F8,0x0000,0x0000,0x0000
    },
    // P
    {
        0x0000,0x3FF8,0x3FFC,0x300C,0x300C,0x3FF8,0x3FFC,0x3000,
        0x3000,0x3000,0x3000,0x3000,0x0000,0x0000,0x0000,0x0000
    },
    // Q
    {
        0x0000,0x07F8,0x0FFC,0x1C0C,0x300C,0x300C,0x300C,0x300C,
        0x300C,0x301C,0x1C0C,0x0FFC,0x07F8,0x000C,0x0000,0x0000
    },
    // R
    {
        0x0000,0x3FF8,0x3FFC,0x300C,0x300C,0x3FF8,0x3FFC,0x3038,
        0x301C,0x300C,0x300C,0x300C,0x0000,0x0000,0x0000,0x0000
    },
    // S
    {
        0x0000,0x07F8,0x0FFC,0x1C0C,0x3000,0x1FF8,0x0FFC,0x000C,
        0x000C,0x300C,0x1C0C,0x0FFC,0x07F8,0x0000,0x0000,0x0000
    },
    // T
    {
        0x0000,0x3FFC,0x3FFC,0x0180,0x0180,0x0180,0x0180,0x0180,
        0x0180,0x0180,0x0180,0x0180,0x0000,0x0000,0x0000,0x0000
    },
    // U
    {
        0x0000,0x300C,0x300C,0x300C,0x300C,0x300C,0x300C,0x300C,
        0x300C,0x300C,0x1C1C,0x0FF8,0x07F0,0x0000,0x0000,0x0000
    },
    // V
    {
        0x0000,0x300C,0x300C,0x300C,0x300C,0x300C,0x1818,0x1818,
        0x0C30,0x0C30,0x07E0,0x03C0,0x0000,0x0000,0x0000,0x0000
    },
    // W
    {
        0x0000,0x300C,0x300C,0x300C,0x3FFC,0x3FFC,0x3FFC,0x3FFC,
        0x3FFC,0x3FFC,0x3FFC,0x300C,0x0000,0x0000,0x0000,0x0000
    },
    // X
    {
        0x0000,0x300C,0x1818,0x0C30,0x07E0,0x03C0,0x03C0,0x07E0,
        0x0C30,0x1818,0x300C,0x300C,0x0000,0x0000,0x0000,0x0000
    },
    // Y
    {
        0x0000,0x300C,0x1818,0x0C30,0x07E0,0x03C0,0x0180,0x0180,
        0x0180,0x0180,0x0180,0x0180,0x0000,0x0000,0x0000,0x0000
    },
    // Z
    {
        0x0000,0x3FFC,0x3FFC,0x0030,0x0060,0x00C0,0x0180,0x0300,
        0x0600,0x0C00,0x1800,0x3FFC,0x3FFC,0x0000,0x0000,0x0000
    }
};