
#include <stdio.h>
#include "freertos/FreeRTOS.h"
#include "freertos/task.h"
#include "driver/spi_master.h"
#include "driver/gpio.h"
#include "esp_lcd_panel_io.h"
#include "esp_lcd_panel_vendor.h"
#include "esp_lcd_panel_ops.h"
#include "esp_log.h"
#include "LCD.h"

esp_lcd_panel_handle_t g_panel_handle = NULL;

// 全局LCD缓冲区
uint16_t *g_lcd_buffer = NULL;

// 分配LCD缓冲区
size_t buffer_size = LCD_H_RES * LCD_V_RES;


// 假设 font8x8_basic['A'] 是字符'A'的8x8点阵
// 使用5x7点阵ASCII字库绘制字符
void lcd_draw_char(int x, int y, char c, uint16_t color) {
    // int scale = 2; // 放大倍数
    int char_width = 5 * 2 + 2;
    int char_height = 7 * 2 + 2;
    lcd_clear_buffer(x, y, char_width, char_height, 0x0000); // 只擦除字符区域
    // 支持从空格(0x20)到波浪号(0x7E)
    if (c < 0x20 || c > 0x7E) return;
    int idx = c - 0x20;
    int scale = 2; // 放大倍数
    for (int col = 0; col < 10; col++) {
        for (int row = 0; row < 7; row++) {
            unsigned char bits = ASCII_5x7[idx][row];
            if (bits & (1 << col)) {
                // 每个点扩展为scale x scale像素块
                for (int dx = 0; dx < scale; dx++) {
                    for (int dy = 0; dy < scale; dy++) {
                        int px = x + row * scale + dx;
                        int py = y + col * scale + dy;
                        if (px >= 0 && px < LCD_H_RES && py >= 0 && py < LCD_V_RES) {
                            g_lcd_buffer[py * LCD_H_RES + px] = color;
                        }
                    }
                }
            }
        }
    }
}

void lcd_draw_string(int x, int y, const char *str, uint16_t color) {
    
    int cursor_x = x;
    int char_width = 5 * 2; // 放大后宽度
    int char_gap = 2 * 2;   // 放大后间隔
    while (*str) {
        if (cursor_x + char_width > LCD_H_RES) break;
        lcd_draw_char(cursor_x, y, *str, color);
        cursor_x += char_width + char_gap;
        str++;
    }
    esp_lcd_panel_draw_bitmap(g_panel_handle, 0, 0, LCD_H_RES, LCD_V_RES, g_lcd_buffer);
}

void lcd_draw_string2(int x, int y, const char *str, uint16_t color) {
    int cursor_x = x;
    int char_width = 5 * 2;
    int char_gap = 2 * 2;
    while (*str) {
        if (cursor_x + char_width > LCD_H_RES) break;
        lcd_draw_char(cursor_x, y, *str, color);
        cursor_x += char_width + char_gap;
        str++;
    }
    esp_lcd_panel_draw_bitmap(g_panel_handle, 0, 0, LCD_H_RES, LCD_V_RES, g_lcd_buffer);
}

//     // 打印int32范围的整数，包括正负号
void lcd_draw_int32(int x, int y, long int value, uint16_t color) {
    char str[12]; // 最长-2147483648\0
    snprintf(str, sizeof(str), "%ld", value);
    lcd_draw_string2(x, y, str, color);
}


// 显示一张图片到指定位置
// image: 图像数据（RGB565），width/height: 图像宽高
void lcd_draw_image(int x, int y, int width, int height, const uint16_t *image) {
    lcd_clear_buffer(x,y,width,height,0x0000);
    for (int row = 0; row < height; row++) {
        for (int col = 0; col < width; col++) {
            int px = x + col;
            int py = y + row;
            if (px >= 0 && px < LCD_H_RES && py >= 0 && py < LCD_V_RES) {
                g_lcd_buffer[py * LCD_H_RES + px] = image[row * width + col];
            }
        }
    }
    esp_lcd_panel_draw_bitmap(g_panel_handle, 0, 0, LCD_H_RES, LCD_V_RES, g_lcd_buffer);
}


// 清除缓冲区指定区域，将像素设置为指定颜色
void lcd_clear_buffer(int x, int y, int width, int height, uint16_t color) {
    // 如果未指定区域，则默认全屏
    if (width <= 0 || height <= 0) {
        x = 0;
        y = 0;
        width = LCD_H_RES;
        height = LCD_V_RES;
    }
    for (int row = 0; row < height; row++) {
        for (int col = 0; col < width; col++) {
            int px = x + col;
            int py = y + row;
            if (px >= 0 && px < LCD_H_RES && py >= 0 && py < LCD_V_RES) {
                g_lcd_buffer[py * LCD_H_RES + px] = color;
            }
        }
    }
    esp_lcd_panel_draw_bitmap(g_panel_handle, x, y, x + width, y + height, g_lcd_buffer);
}


// LCD初始化模块
void lcd_init(void) {

    ESP_LOGI("ST7789", "Initialize SPI bus");
    spi_bus_config_t buscfg = {
        .sclk_io_num = PIN_NUM_SCLK,
        .mosi_io_num = PIN_NUM_MOSI,
        .miso_io_num = PIN_NUM_MISO,
        .quadwp_io_num = -1,
        .quadhd_io_num = -1,
        .max_transfer_sz = LCD_H_RES * LCD_V_RES * sizeof(uint16_t),
    };
    ESP_ERROR_CHECK(spi_bus_initialize(LCD_HOST, &buscfg, SPI_DMA_CH_AUTO));

    ESP_LOGI("ST7789", "Install panel IO");
    esp_lcd_panel_io_handle_t io_handle = NULL;
    esp_lcd_panel_io_spi_config_t io_config = {
        .dc_gpio_num = PIN_NUM_DC,
        .cs_gpio_num = PIN_NUM_CS,
        .pclk_hz = LCD_PIXEL_CLOCK_HZ,
        .lcd_cmd_bits = 8,
        .lcd_param_bits = 8,
        .spi_mode = 0,
        .trans_queue_depth = 10,
    };
    ESP_ERROR_CHECK(esp_lcd_new_panel_io_spi((esp_lcd_spi_bus_handle_t)LCD_HOST, &io_config, &io_handle));

    ESP_LOGI("ST7789", "Install ST7789 panel driver");
    esp_lcd_panel_handle_t panel_handle = NULL;
    esp_lcd_panel_dev_config_t panel_config = {
        .reset_gpio_num = PIN_NUM_RST,
        .color_space = ESP_LCD_COLOR_SPACE_BGR,
        .bits_per_pixel = 16,
    };
    ESP_ERROR_CHECK(esp_lcd_new_panel_st7789(io_handle, &panel_config, &panel_handle));

    ESP_ERROR_CHECK(esp_lcd_panel_reset(panel_handle));
    ESP_ERROR_CHECK(esp_lcd_panel_init(panel_handle));
    ESP_ERROR_CHECK(esp_lcd_panel_disp_on_off(panel_handle, true));

    gpio_config_t bk_gpio_config = {
        .mode = GPIO_MODE_OUTPUT,
        .pin_bit_mask = 1ULL << PIN_NUM_BCKL,
    };
    ESP_ERROR_CHECK(gpio_config(&bk_gpio_config));
    ESP_ERROR_CHECK(gpio_set_level(PIN_NUM_BCKL, 0));

    g_panel_handle = panel_handle;
    g_lcd_buffer = heap_caps_malloc(buffer_size * sizeof(uint16_t), MALLOC_CAP_DMA | MALLOC_CAP_8BIT);
    // 不再返回panel_handle，专注于初始化
    for (int i = 0; i < buffer_size; i++){
        g_lcd_buffer[i] = 0x0000;
    } 
    esp_lcd_panel_draw_bitmap(g_panel_handle, 0, 0, LCD_H_RES, LCD_V_RES, g_lcd_buffer);
}



/* ASCII字模库 - 5x7点阵 */
/* 每个字符用7字节表示，每字节代表一行点阵（低位在上） */
const unsigned char ASCII_5x7[96][7] = { // 从空格(0x20)到波浪号(0x7E)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},   // 空格 ( )
    {0x00, 0x00, 0x5F, 0x00, 0x00, 0x00, 0x00},   // ! 
    {0x00, 0x07, 0x00, 0x07, 0x00, 0x00, 0x00},   // "
    {0x14, 0x7F, 0x14, 0x7F, 0x14, 0x00, 0x00},   // #
    {0x24, 0x2A, 0x7F, 0x2A, 0x12, 0x00, 0x00},   // $
    {0x23, 0x13, 0x08, 0x64, 0x62, 0x00, 0x00},   // %
    {0x36, 0x49, 0x55, 0x22, 0x50, 0x00, 0x00},   // &
    {0x00, 0x05, 0x03, 0x00, 0x00, 0x00, 0x00},   // '
    {0x00, 0x1C, 0x22, 0x41, 0x00, 0x00, 0x00},   // (
    {0x00, 0x41, 0x22, 0x1C, 0x00, 0x00, 0x00},   // )
    {0x14, 0x08, 0x3E, 0x08, 0x14, 0x00, 0x00},   // *
    {0x08, 0x08, 0x3E, 0x08, 0x08, 0x00, 0x00},   // +
    {0x00, 0x50, 0x30, 0x00, 0x00, 0x00, 0x00},   // ,
    {0x08, 0x08, 0x08, 0x08, 0x08, 0x00, 0x00},   // -
    {0x00, 0x60, 0x60, 0x00, 0x00, 0x00, 0x00},   // .
    {0x20, 0x10, 0x08, 0x04, 0x02, 0x00, 0x00},   // /
    {0x3E, 0x51, 0x49, 0x45, 0x3E, 0x00, 0x00},   // 0
    {0x00, 0x42, 0x7F, 0x40, 0x00, 0x00, 0x00},   // 1
    {0x42, 0x61, 0x51, 0x49, 0x46, 0x00, 0x00},   // 2
    {0x21, 0x41, 0x45, 0x4B, 0x31, 0x00, 0x00},   // 3
    {0x18, 0x14, 0x12, 0x7F, 0x10, 0x00, 0x00},   // 4
    {0x27, 0x45, 0x45, 0x45, 0x39, 0x00, 0x00},   // 5
    {0x3C, 0x4A, 0x49, 0x49, 0x30, 0x00, 0x00},   // 6
    {0x01, 0x71, 0x09, 0x05, 0x03, 0x00, 0x00},   // 7
    {0x36, 0x49, 0x49, 0x49, 0x36, 0x00, 0x00},   // 8
    {0x06, 0x49, 0x49, 0x29, 0x1E, 0x00, 0x00},   // 9
    {0x00, 0x36, 0x36, 0x00, 0x00, 0x00, 0x00},   // :
    {0x00, 0x56, 0x36, 0x00, 0x00, 0x00, 0x00},   // ;
    {0x08, 0x14, 0x22, 0x41, 0x00, 0x00, 0x00},   // <
    {0x14, 0x14, 0x14, 0x14, 0x14, 0x00, 0x00},   // =
    {0x00, 0x41, 0x22, 0x14, 0x08, 0x00, 0x00},   // >
    {0x02, 0x01, 0x51, 0x09, 0x06, 0x00, 0x00},   // ?
    {0x32, 0x49, 0x79, 0x41, 0x3E, 0x00, 0x00},   // @
    {0x7E, 0x11, 0x11, 0x11, 0x7E, 0x00, 0x00},   // A
    {0x7F, 0x49, 0x49, 0x49, 0x36, 0x00, 0x00},   // B
    {0x3E, 0x41, 0x41, 0x41, 0x22, 0x00, 0x00},   // C
    {0x7F, 0x41, 0x41, 0x22, 0x1C, 0x00, 0x00},   // D
    {0x7F, 0x49, 0x49, 0x49, 0x41, 0x00, 0x00},   // E
    {0x7F, 0x09, 0x09, 0x09, 0x01, 0x00, 0x00},   // F
    {0x3E, 0x41, 0x49, 0x49, 0x7A, 0x00, 0x00},   // G
    {0x7F, 0x08, 0x08, 0x08, 0x7F, 0x00, 0x00},   // H
    {0x00, 0x41, 0x7F, 0x41, 0x00, 0x00, 0x00},   // I
    {0x20, 0x40, 0x41, 0x3F, 0x01, 0x00, 0x00},   // J
    {0x7F, 0x08, 0x14, 0x22, 0x41, 0x00, 0x00},   // K
    {0x7F, 0x40, 0x40, 0x40, 0x40, 0x00, 0x00},   // L
    {0x7F, 0x02, 0x0C, 0x02, 0x7F, 0x00, 0x00},   // M
    {0x7F, 0x04, 0x08, 0x10, 0x7F, 0x00, 0x00},   // N
    {0x3E, 0x41, 0x41, 0x41, 0x3E, 0x00, 0x00},   // O
    {0x7F, 0x09, 0x09, 0x09, 0x06, 0x00, 0x00},   // P
    {0x3E, 0x41, 0x51, 0x21, 0x5E, 0x00, 0x00},   // Q
    {0x7F, 0x09, 0x19, 0x29, 0x46, 0x00, 0x00},   // R
    {0x46, 0x49, 0x49, 0x49, 0x31, 0x00, 0x00},   // S
    {0x01, 0x01, 0x7F, 0x01, 0x01, 0x00, 0x00},   // T
    {0x3F, 0x40, 0x40, 0x40, 0x3F, 0x00, 0x00},   // U
    {0x1F, 0x20, 0x40, 0x20, 0x1F, 0x00, 0x00},   // V
    {0x3F, 0x40, 0x38, 0x40, 0x3F, 0x00, 0x00},   // W
    {0x63, 0x14, 0x08, 0x14, 0x63, 0x00, 0x00},   // X
    {0x07, 0x08, 0x70, 0x08, 0x07, 0x00, 0x00},   // Y
    {0x61, 0x51, 0x49, 0x45, 0x43, 0x00, 0x00},   // Z
    {0x00, 0x7F, 0x41, 0x41, 0x00, 0x00, 0x00},   // [
    {0x02, 0x04, 0x08, 0x10, 0x20, 0x00, 0x00},   // "\"
    {0x00, 0x41, 0x41, 0x7F, 0x00, 0x00, 0x00},   // ]
    {0x04, 0x02, 0x01, 0x02, 0x04, 0x00, 0x00},   // ^
    {0x40, 0x40, 0x40, 0x40, 0x40, 0x00, 0x00},   // _
    {0x00, 0x01, 0x02, 0x04, 0x00, 0x00, 0x00},   // `
    {0x20, 0x54, 0x54, 0x54, 0x78, 0x00, 0x00},   // a
    {0x7F, 0x48, 0x44, 0x44, 0x38, 0x00, 0x00},   // b
    {0x38, 0x44, 0x44, 0x44, 0x20, 0x00, 0x00},   // c
    {0x38, 0x44, 0x44, 0x48, 0x7F, 0x00, 0x00},   // d
    {0x38, 0x54, 0x54, 0x54, 0x18, 0x00, 0x00},   // e
    {0x08, 0x7E, 0x09, 0x01, 0x02, 0x00, 0x00},   // f
    {0x0C, 0x52, 0x52, 0x52, 0x3E, 0x00, 0x00},   // g
    {0x7F, 0x08, 0x04, 0x04, 0x78, 0x00, 0x00},   // h
    {0x00, 0x44, 0x7D, 0x40, 0x00, 0x00, 0x00},   // i
    {0x20, 0x40, 0x44, 0x3D, 0x00, 0x00, 0x00},   // j
    {0x7F, 0x10, 0x28, 0x44, 0x00, 0x00, 0x00},   // k
    {0x00, 0x41, 0x7F, 0x40, 0x00, 0x00, 0x00},   // l
    {0x7C, 0x04, 0x18, 0x04, 0x78, 0x00, 0x00},   // m
    {0x7C, 0x08, 0x04, 0x04, 0x78, 0x00, 0x00},   // n
    {0x38, 0x44, 0x44, 0x44, 0x38, 0x00, 0x00},   // o
    {0x7C, 0x14, 0x14, 0x14, 0x08, 0x00, 0x00},   // p
    {0x08, 0x14, 0x14, 0x18, 0x7C, 0x00, 0x00},   // q
    {0x7C, 0x08, 0x04, 0x04, 0x08, 0x00, 0x00},   // r
    {0x48, 0x54, 0x54, 0x54, 0x20, 0x00, 0x00},   // s
    {0x04, 0x3F, 0x44, 0x40, 0x20, 0x00, 0x00},   // t
    {0x3C, 0x40, 0x40, 0x20, 0x7C, 0x00, 0x00},   // u
    {0x1C, 0x20, 0x40, 0x20, 0x1C, 0x00, 0x00},   // v
    {0x3C, 0x40, 0x30, 0x40, 0x3C, 0x00, 0x00},   // w
    {0x44, 0x28, 0x10, 0x28, 0x44, 0x00, 0x00},   // x
    {0x0C, 0x50, 0x50, 0x50, 0x3C, 0x00, 0x00},   // y
    {0x44, 0x64, 0x54, 0x4C, 0x44, 0x00, 0x00},   // z
    {0x00, 0x08, 0x36, 0x41, 0x00, 0x00, 0x00},   // {
    {0x00, 0x00, 0x7F, 0x00, 0x00, 0x00, 0x00},   // |
    {0x00, 0x41, 0x36, 0x08, 0x00, 0x00, 0x00},   // }
    {0x08, 0x08, 0x2A, 0x1C, 0x08, 0x00, 0x00},   // ~
};